version: 1.0.{build}
shallow_clone: true
clone_folder: C:\Projects\libsfw
init:
- ps: >-
    Start-process -FilePath msiexec -ArgumentList '/X','{177B605A-B1E1-3197-B5D4-05F00C0174D1}','/q' -Wait;

    Start-Process -FilePath "C:\Program Files (x86)\Mozilla Maintenance Service\uninstall.exe" -ArgumentList '/S' -Wait

    Invoke-WebRequest -UseBasicParsing -Uri https://github.com/s3tools/s3cmd/releases/download/v2.2.0/s3cmd-2.2.0.zip -OutFile $env:TEMP\s3cmd-2.2.0.zip

    unzip $env:TEMP\s3cmd-2.2.0.zip -d C:\Projects

    Rename-Item -Path C:\Projects\s3cmd-2.2.0 -NewName s3cmd -Confirm:$false -Force

    Start-Process -FilePath C:\Python310\python.exe -ArgumentList "-m","pip install","--upgrade","pip" -Wait
    
    pip install python-dateutil

    Start-Process -FilePath python -ArgumentList "C:\Projects\s3cmd\setup.py","install" -Wait

    Invoke-WebRequest -UseBasicParsing -Uri https://raw.githubusercontent.com/repasscloud/init-files/main/s3cmd.ini -OutFile C:\Users\appveyor\AppData\Roaming\s3cmd.ini

    (Get-Content -Path C:\Users\appveyor\AppData\Roaming\s3cmd.ini) -replace "ACCESS_KEY_GOES_HERE", "$env:S3ACCESSKEY" | Out-File -FilePath C:\Users\appveyor\AppData\Roaming\s3cmd.ini -Force

    (Get-Content -Path C:\Users\appveyor\AppData\Roaming\s3cmd.ini) -replace "SECRET_KEY_GOES_HERE", "$env:S3SECRETKEY" | Out-File -FilePath C:\Users\appveyor\AppData\Roaming\s3cmd.ini -Force

    (Get-Content -Path C:\Users\appveyor\AppData\Roaming\s3cmd.ini) -replace "https://www.com", "$env:S3URL" | Out-File -FilePath C:\Users\appveyor\AppData\Roaming\s3cmd.ini -Force    
install:
- ps: >-
    Get-ChildItem -Path .\apps -Recurse -Filter "*.ps1" | ForEach-Object { . $_.FullName }
build_script:
- ps: >-
    python C:\Projects\s3cmd\s3cmd put C:\Projects\libsfw\apps\adobe\readerdc\adobe.readerdc.latest.json s3://usrdata-01/adobe/readerdc/adobe.readerdc.latest.json
test_script:
- ps: >-
    Write-Output "This is test script"
deploy_script:
- pwsh: Write-Output "This is deployment script"
on_success:
- ps: '[System.Console]::WriteLine("Success building")'
on_failure:
- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
on_finish:
- ps: '[System.Console]::WriteLine("Project finished building")'
